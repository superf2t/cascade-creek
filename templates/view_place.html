{% extends "layout.html" %}
{% block css %}
    <style>
    #map {
        height: 500px;
        width: 100%;
    }
    #for_sale_listings_container {
        height: 500px;
        overflow-y: scroll;
        padding: 0;
    }
    
    .table > tbody > tr > td {
        vertical-align: middle;
    }
    
    .w180 { width: 180px; }
    table.td-right td { text-align: right; }
    .smallme tbody tr th { padding: 2px; }
    .smallme tbody tr td { padding: 2px; }

    .bottom-line { border-bottom: solid 1px #cccccc; }
    </style>
{% endblock %}
{% block body %}

    
    <h1>{{ place.name }} &nbsp;&nbsp;&nbsp;<small>
    {% if current_user.id == 'travis' %}
            <a href="/place/view_place/{{ place.place_id }}/queue" class="btn btn-primary">Scrape Airbnb</a></small>
    {% endif %}
    </h1>
    <h3>{{ place.listing_count }} Listings</h3>

    <br />

    <div class="row">
        <div class="col-md-9"><div id="map"></div></div>
        <div class="col-md-3" id="for_sale_listings_container">
            <table id="for_sale_listings" class="table table-striped table-condensed">
            <tr>
                <th>&nbsp;</th>
                <th>Bed/Bath</th>
                <th>Price</th>
                <th>Cap</th>
            </tr>
            </table>
        </div>
    </div>
    

    <div id="avg_by_num_bedrooms_div"></div>

    <form>
    <h3>Monthly Ownership Costs</h3>
    <div class="alert alert-success" style="display: none;" id="monthly_ownership_costs_message"></div>
    <table class="table">
        <tr>
            <th>Monthly Management Fee %</th>
            <td class="w180">
                <div class="input-group">
                    <input type="text" class="form-control" id="monthly_management_fee" placeholder="Percent" value="{{ place.monthly_management_fee }}">
                    <div class="input-group-addon">%</div>
                </div>
            </td>
        </tr>
        <tr>
            <th>Monthly Property Tax/$100k</th>
            <td class="w180">
                <div class="input-group">
                    <div class="input-group-addon">$</div>
                    <input type="text" class="form-control" id="monthly_property_tax_per_100k" placeholder="Amount" value="{{ place.monthly_property_tax_per_100k }}">
                </div>
            </td>
        </tr>
        <tr>
            <th>Monthly Mortgage Insurance/$100k</th>
            <td class="w180">
                <div class="input-group">
                    <div class="input-group-addon">$</div>
                    <input type="text" class="form-control" id="monthly_mortgage_insurance_per_100k" placeholder="Amount" value="{{ place.monthly_mortgage_insurance_per_100k }}">
                </div>
            </td>
        </tr>
        <tr>
            <th>Monthly Short Term Insurance/$100k</th>
            <td class="w180">
                <div class="input-group">
                    <div class="input-group-addon">$</div>
                    <input type="text" class="form-control" id="monthly_short_term_insurance_per_100k" placeholder="Amount" value="{{ place.monthly_short_term_insurance_per_100k }}">
                </div>
            </td>
        </tr>
        <tr>
            <th>Monthly Utilities/1 sq/ft</th>
            <td class="w180">
                <div class="input-group">
                    <div class="input-group-addon">$</div>
                    <input type="text" class="form-control" id="monthly_utilities_per_sq_ft" placeholder="Amount" value="{{ place.monthly_utilities_per_sq_ft }}">
                </div>
            </td>
        </tr>
        <tr>
            <th>Monthly Internet Service</th>
            <td class="w180">
                <div class="input-group">
                    <div class="input-group-addon">$</div>
                    <input type="text" class="form-control" id="monthly_internet_fee" placeholder="Amount" value="{{ place.monthly_internet_fee }}">
                </div>
            </td>
        </tr>
        <tr>
        <th>&nbsp;</th>
        <td><input type="button" class="btn btn-primary" id="submit_monthly_fee_form" onclick="handle_submit_monthly_fee_form()" value="Submit"></td>
        </tr>
    </table>
    </form>


    {% raw %}
    <script type="text/x-tmpl" id="avg_by_num_bedrooms_tmpl">

            <h3>Monthly Average by Num Bedrooms</h3>
            <table class="table table-striped">
            <tr>
                <th align="center">Bedrooms</th>
                <th align="center">Rental Houses</th>
                <th align="center">Avg Monthly</th>
                <th align="center">80th%</th>
                <th align="center"># For Sale</th>
                <th align="center">Avg Cost of Ownership</th>
                <th align="center">Cap rate</th>
                <th align="center">ROI</th>
            </tr>
            {% for (var i=0; i < o.length; i++) { %}
                <tr id="bedroms_{{ row.i_bedrooms }}">
                    <td align="center" style="background-color: {%= getColor(o[i].i_bedrooms) %}">{%= o[i].i_bedrooms %}</td>
                    <td align="center">{%= o[i].count_homes %}</td>
                    <td align="center">${%= o[i].avg_bookings %}</td>
                    <td align="center">${%= o[i].eighty_pct %}</td>
                    <td align="center">
                        {% if (o[i].count_for_sale) { %}
                            {%= o[i].count_for_sale %}
                        {% } %}
                    </td>
                    <td align="center">
                        {% if (o[i].avg_cost) { %}
                            ${%= o[i].avg_cost %}
                        {% } %}
                    </td>
                    {% if (o[i].avg_bookings && o[i].avg_cost) { 

                        down_payment = calculateDownPayment(o[i].avg_price);
                        yearly_net_80 = (o[i].eighty_pct - o[i].avg_cost) * 12;
                        closing_costs = calculateClosingCosts(o[i].avg_price);
                        furnishing_costs = calculateFurnishingCosts(o[i].avg_price);
                        yearly_roi_80 = calculateROI(yearly_net_80, down_payment, closing_costs, furnishing_costs);
                        
                        cap_rate_80 = calculateCapRate(o[i].avg_price, o[i].eighty_pct, o[i].avg_cost, o[i].avg_mortgage);

                        var td_class = "";
                        if (cap_rate_80 > 10) {
                            td_class = "success";
                        }
                        else if (cap_rate_80 < 10) {
                            td_class = "danger"; 
                        }  %}
                        <td align="center" class="{%= td_class %}">{%= displayNumber(cap_rate_80, 1, '%') %}</td>
                        <td align="center" class="{%= td_class %}">{%= displayNumber(yearly_roi_80, 0, '%') %}</td>
                    {% }
                       else { %}
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    {% } %}

                    
                </tr>
            {% } %}
            </table>


    </script>


    <script type="text/x-tmpl" id="for_sale_houses_tmpl">
        <tr id="{%= o.id %}" data-cap="{%= displayNumber(o.cap_rate_80, 1) %}" 
            onclick="google.maps.event.trigger(forSaleMarkers[{%= o.id %}], 'click');" 
            onmouseover="javascript:forSaleMarkers[{%= o.id %}].setAnimation(google.maps.Animation.BOUNCE);" 
            onmouseout="javascript:forSaleMarkers[{%= o.id %}].setAnimation(-1);;">
                <td><img src="https://thumbs.trulia-cdn.com{%= o.photo_url %}" width="50" /></td>
                <td>{%= o.bedrooms + '/' + o.bathrooms %}</td>
                <td>{%= o.short_price %}</td>
                <td>{%= displayNumber(o.cap_rate_80, 1, '%') %}</td>
        </tr>
    </script>
    {% endraw %}


    <div class="modal fade" id="modal_house_analysis">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    
                    <div class="row">
                        <div class="col-sm-12 text-center">
                            <h3>Proforma for <span id="profit_loss_address"></span></h3>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4 text-center">
                            <h5>Bedrooms: <span id="profit_loss_bedrooms"></span></h5>
                        </div>
                        <div class="col-sm-4 text-center">
                            <h5>Bathrooms: <span id="profit_loss_bathrooms"></span></h5>
                        </div>
                        <div class="col-sm-4 text-center">
                            <h5>Sq/Ft: <span id="profit_loss_sq_ft"></span></h5>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-sm-12"><h4>Acquisition</h4></div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Price:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_price"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Down payment:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_down_payment"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Closing costs:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_closing_costs"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1 bottom-line">Furnishing costs:</div>
                        <div class="col-sm-2 text-right bottom-line">
                            <span id="profit_loss_furnishing_costs"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Total acquisition cost:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_total_acquisition_cost"></span></b>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-12"><h4>Costs</h4></div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Mortgage payment:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_mortgage_payment"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Property tax:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_property_tax"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Mortgage insurance:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_mortgage_insurance"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Short Term Insurance:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_short_term_insurance"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">HOA:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_hoa">???</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Utilities + Internet:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_utilities_internet"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Repairs:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_repairs"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1 bottom-line">Management Fee:</div>
                        <div class="col-sm-2 text-right bottom-line">
                            <span id="profit_loss_management_fee"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Monthly Operating Expense:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_op_ex_per_month"></span></b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Annual Operating Expense:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_op_ex_per_year"></span></b>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-12"><h4>Average Return</h4></div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Monthly Average Revenue:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_bookings_average"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1 bottom-line">Monthly Operating Expense:</div>
                        <div class="col-sm-2 text-right bottom-line">
                            <span id="profit_loss_op_ex_per_month_2"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Monthly Net Profit:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_monthly_net_average"></span></b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Annual net profit:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_yearly_net_average"></span></b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Annual ROI:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_yearly_roi_average"></span></b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Cap rate:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_cap_rate_average"></span></b>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-12"><h4>80th Percentile Return</h4></div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">80th% Revenue:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_bookings_eighty_percent"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1 bottom-line">Monthly Operating Expense:</div>
                        <div class="col-sm-2 text-right bottom-line">
                            <span id="profit_loss_op_ex_per_month_3"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Monthly net profit:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_monthly_net_80"></span></b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Annual net profit:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_yearly_net_80"></span></b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Annual ROI:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_yearly_roi_80"></span></b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Cap rate:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_cap_rate_80"></span></b>
                        </div>
                    </div>
                    
                </div> <!-- /.modal-body -->
            </div> <!-- /.modal-content -->
        </div> <!-- /.modal-dialog -->
    </div>


    <script>
    var map = null;
    var forSaleMarkers = [];

    var avg_bookings_by_bedrooms = {{ avg_bookings_by_bedrooms|tojson }};
    var colors = {{ colors|tojson }};

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 3
        });

        var rectangle = new google.maps.Rectangle({
            strokeColor: '#FF0000',
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: '#000000',
            fillOpacity: 0,
            map: map,
            bounds: {
                north: {{ place.ne_lat }},
                south: {{ place.sw_lat }},
                east: {{ place.ne_lng }},
                west: {{ place.sw_lng }}
            }
        });

        getListings();  
    }

    /* ajaxFunctions */
    function getListings () {
        $.getJSON('/place/_listings_geojson/{{ place.place_id }}', function(listings) {

            //var heatmapData = [];
            var bounds = new google.maps.LatLngBounds();

            bounds.extend(new google.maps.LatLng({{ place.ne_lat }}, {{ place.ne_lng }}))
            bounds.extend(new google.maps.LatLng({{ place.sw_lat }}, {{ place.sw_lng }}))

            for (i = 0; i < listings.length; i++) {

                var latLng = new google.maps.LatLng(listings[i]['lat'], listings[i]['lng'])
                bounds.extend(latLng)

                var marker = new google.maps.Marker({
                    map: map,
                    position: latLng,
                    clickable: true,
                    icon: getCircle(listings[i]['count_nights_rank'], listings[i]['total_bookings_rank'], getColor(listings[i]['bedrooms']))
                });
                marker.note = '<div>' + 
                                '<table width="100%"><tr>' +
                                '<td align="center" style="padding-right: 20px;">' +
                                    '<h3 style="margin-top: 0;"><a href="https://www.airbnb.com/rooms/' + listings[i]['listing_id'] + '" target="_new">' + listings[i]['name'] + '</a></h3>' +
                                    '<img src="' + listings[i]['picture_url'] + '" height="180" style="margin-left: 15px;">' +
                                '</td>' +
                                '<td style="margin-top: 30px;">' +
                                    '<table class="table table-striped smallme">' +
                                    '<tr><th>Beds/Baths:</th><td> ' + listings[i]['bedrooms'] + '/' + listings[i]['bathrooms'] + '</td></tr>' +
                                    '<tr><th>Nightly Rate:</th><td>' + listings[i]['rate'] + '</td></tr>' +
                                    '<tr><th>Star rating:</th><td> ' + listings[i]['star_rating'] + '</td></tr>' +
                                    '<tr><th>Num reviews:</th><td> ' + listings[i]['count_reviews'] + '</td></tr>' +
                                    '<tr><th>Beds:</th><td> ' + listings[i]['beds'] + '</td></tr>' +
                                    '<tr><th>Person capacity:</th><td> ' + listings[i]['person_capacity'] + '</td></tr>' +
                                    '<tr><th>Avg Monthly Bookings:</th><td> $' + listings[i]['avg_monthly_bookings'] + '</td></tr>' + 
                                    '</table>' +
                                '</td>' +
                                '</tr></table>' +
                                '</div>';

                var infoWindow = new google.maps.InfoWindow();

                marker.addListener('click', function() {
                    infoWindow.setContent(this.note);
                    infoWindow.open(this.getMap(), this);
                });

            };

            map.fitBounds(bounds);

            getForSale({{ place.ne_lat }}, {{ place.ne_lng }}, {{ place.sw_lat }}, {{ place.sw_lng}});

            map.addListener('dragend', function() {
                clearForSale();
                ne = map.getBounds().getNorthEast();
                sw = map.getBounds().getSouthWest();
                getForSale(ne.lat(), ne.lng(), sw.lat(), sw.lng());
            });
            
            map.addListener('zoom_changed', function() {
                clearForSale();
                ne = map.getBounds().getNorthEast();
                sw = map.getBounds().getSouthWest();
                getForSale(ne.lat(), ne.lng(), sw.lat(), sw.lng());
            });
            

        });
    }

    function getForSale(ne_lat, ne_lng, sw_lat, sw_lng) {

        //empty the scroller
        $('#for_sale_listings').find("tr:gt(0)").remove();

        //get some for sale listings in this area
        $.getJSON('/place/_for_sale/' + ne_lat + '/' + ne_lng + '/' + sw_lat + '/' + sw_lng, function(results) {
    
            if (results.success != false) {
                //loop and put markers on screen
                for (var i = 0; i < results.page.cards.length; i++) {
                    
                    card = results.page.cards[i];

                    if (card.beds !== undefined) {

                        offset = Math.random() / 5000;
                        offset2 = Math.random() / 5000;

                        var latLng = new google.maps.LatLng(card.latLng[0] + offset, card.latLng[1] + offset2);

                        var marker = new google.maps.Marker({
                            map: map,
                            position: latLng,
                            icon: {
                                path: google.maps.SymbolPath.FORWARD_OPEN_ARROW,
                                scale: 2,
                                labelOrigin: new google.maps.Point(0, 8),
                                strokeColor: getColor(card.beds)

                                /*
                                url: '/static/images/home' + cleanNumber(card.beds) + '.png',
                                labelOrigin: new google.maps.Point(0, 25),
                                scaledSize: {
                                    height: 20,
                                    width: 20
                                }
                                */
                            },
                            label: {
                                text: 'wait for it...',
                                color: getColor(card.beds),
                                fontSize: '10px'
                            },
                            address: card.streetAddress,
                            bedrooms: card.beds,
                            bathrooms: card.baths,
                            price: card.price,
                            short_price: card.shortPrice,
                            sqft: card.sqft,
                            photo_url: card.photoUrl,
                            id: forSaleMarkers.length
                        });

                        house_analysis = singleHouseAnalysis(marker);
                        this_bookings = getAvgBookingsByBedrooms(card.beds);
                        avg_bookings_80 = this_bookings.eighty_pct;

                        marker.label.text = card.shortPrice + '(' + displayNumber(house_analysis.cap_rate_80, 2, "%") + ')';
                        marker.cap_rate_80 = house_analysis.cap_rate_80;

                        marker.note = '<div>' +
                                        '<table width="100%"><tr>' +
                                        '<td align="center" style="padding-right: 20px;">' +
                                            '<h3 style="margin-top: 0;"><a href="https://www.trulia.com' + card.cardUrl + '" target="_new">' + card.streetAddress + '</a></h3>' +
                                            '<img src="https://thumbs.trulia-cdn.com' + card.photoUrl + '" height="180" style="margin-left: 15px;"></td>' +
                                        '<td style="padding-top: 30px;">' +
                                            '<table class="table table-striped smallme">' +
                                            '<tr><th>Beds/Baths:</th><td>' + card.beds + ' / ' + card.baths + '</td></tr>' +
                                            '<tr><th>Sq/ft:</th><td>' + card.sqft + '</td></tr>' +
                                            '<tr><th>Location:</th><td>' + card.footer.location + '</td></tr>' +
                                            '<tr><th>Price:</th><td>' + card.price + '</td></tr>' +
                                            '<tr><th>Revenue/mo:</th><td>' + displayNumber(avg_bookings_80, 0, "$") + '</td></tr>' +
                                            '<tr><th>Cost/mo:</th><td>' + displayNumber(house_analysis.op_ex_per_month, 0, "$") + '</td></tr>' +
                                            '<tr><th>Net profit/mo:</th><td>' + displayNumber(avg_bookings_80 - house_analysis.op_ex_per_month, 0, "$") + '</td></tr>' +
                                            '<tr><th>ROI:</th><td>' + displayNumber(house_analysis.yearly_roi_80, 2, "%") + '</td></tr>' +
                                            '<tr><th>Cap rate:</th><td>' + displayNumber(house_analysis.cap_rate_80, 2, "%") + '</td></tr>' +
                                            '<tr><th colspan="2" align="right"><a href="#modal_house_analysis" data-toggle="modal">Details</a></th></tr>' +
                                            '</table>' +
                                        '</td>' +
                                        '</tr></table>' +
                                      '</div>';

                        forSaleMarkers.push(marker);
                        
                        var infoWindow = new google.maps.InfoWindow();

                        marker.addListener('click', function() {
                            infoWindow.setContent(this.note);
                            infoWindow.open(this.getMap(), this);
                            singleHouseAnalysis(this, true);
                        });

                        //populate the scroller with this house info
                        /*
                        $('#for_sale_listings tr:last').after(
                            tmpl("for_sale_houses_tmpl", marker)
                        );
                        */
                        populateScroller(marker);


                    }

                }

            }
            else {
                console.log('results.page.cards is undefined. Here is results:\n' + JSON.stringify(results) + '\n');

                $('#for_sale_listings tr:last').after("<tr><td colspan='3'>No results returned</td></tr>");
            }

            updateAvgCostAnalysis();
            
        });
    }

    //populate the scroller in order by cap rate desc
    function populateScroller(marker) {
        //$('#for_sale_listings')
        //tmpl("for_sale_houses_tmpl", marker)
        cap_rate = marker.cap_rate_80;

        //get data attribute values of existing tr's and read into array
        var dataList = $("#for_sale_listings tr[data-cap]").map(function() {
            return $(this).data("cap");
        }).get();

        //if no rows are added yet, add it
        if (dataList.length == 0) {
            $('#for_sale_listings tr:last').after(
                tmpl("for_sale_houses_tmpl", marker)
            );
        }
        else {
            //loop through, find the first one this is smaller than, and insert
            for (var i = 0; i < dataList.length; i++) {
                if (cap_rate > dataList[i]) {
                    $('#for_sale_listings tr[data-cap="' + dataList[i] + '"').before(
                        tmpl("for_sale_houses_tmpl", marker)
                    );
                    i = 999;
                }
            }
            //if this is the smallest of the bunch, put it at the end
            if (i < 999) {
                $('#for_sale_listings tr:last').after(
                    tmpl("for_sale_houses_tmpl", marker)
                );       
            }


        }
        

    }

    /* handle monthly costs form submit */
    function handle_submit_monthly_fee_form() {
        var monthly_property_tax_per_100k = $('#monthly_property_tax_per_100k').val();
        var monthly_mortgage_insurance_per_100k = $('#monthly_mortgage_insurance_per_100k').val();
        var monthly_short_term_insurance_per_100k = $('#monthly_short_term_insurance_per_100k').val();
        var monthly_utilities_per_sq_ft = $('#monthly_utilities_per_sq_ft').val();
        var monthly_internet_fee = $('#monthly_internet_fee').val();

        querystring = 'monthly_property_tax_per_100k=' + monthly_property_tax_per_100k +
                        '&monthly_mortgage_insurance_per_100k=' + monthly_mortgage_insurance_per_100k +
                        '&monthly_short_term_insurance_per_100k=' + monthly_short_term_insurance_per_100k +
                        '&monthly_utilities_per_sq_ft=' + monthly_utilities_per_sq_ft +
                        '&monthly_internet_fee=' + monthly_internet_fee


        $.getJSON('/place/_submit_monthly_fee_form/{{ place.place_id }}?' + querystring, function(result) {
            $('#monthly_ownership_costs_message').html(result);
            $('#monthly_ownership_costs_message').show();
            setTimeout(function(){ 
                $('#monthly_ownership_costs_message').hide();
            }, 3000);
        });
    }

        
    /* displayFunctions */

    function getCircle(count_nights_rank, total_bookings_rank, color) {
        return {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: color,
            fillOpacity: Number(total_bookings_rank) / 100, //.2,
            scale: Math.sqrt(count_nights_rank), //Math.pow(2, count_nights_rank) / 2,
            strokeColor: 'white',
            strokeWeight: .5
        };
    }

    function clearForSale() {

        for (var i = 0; i < forSaleMarkers.length; i++) {
            forSaleMarkers[i].setMap(null);
        }
        
        forSaleMarkers = [];

        for (var i = 0; i < avg_bookings_by_bedrooms.length; i++) {
            avg_bookings_by_bedrooms[i].count_for_sale = 0;
            avg_bookings_by_bedrooms[i].avg_cost = 0;
        }
        
    }

    //loop through the forSaleMarkers array and update the average monthly table
    function updateAvgCostAnalysis() {

        var arr = [];

        //loop through 1-5 bedroom houses and update total num houses and total cost
        for (i = 0; i <= 5; i++) {
            
            //grab all the x bedroom houses and put into array
            var result = $.grep(forSaleMarkers, function(item){
                return item.bedrooms == i + 'bd';
            });

            //loop through all houses with x number bedrooms
            if (result.length > 0) {

                //if we haven't started the dictionary for houses with this many bedrooms yet, then start it now
                var exists = arr[i];
                if (!exists)
                    arr[i] = {"count_for_sale": 0, "total_op_ex": 0, "total_price": 0, "avg_price": 0, "avg_cost": 0, "avg_mortgage": 0};

                //read dictionary into var for simple reference
                thisListing = arr[i];

                //loop through all houses with this many bedrooms and update the dictionary
                for (j = 0; j < result.length; j++) {

                    //only try to calculate the results if this is a number
                    if ($.isNumeric(result[j].price.replace(/[^0-9\.]+/g,""))) {
                        thisListing.count_for_sale += 1;

                        var all_costs = singleHouseAnalysis(result[j], false);
                        thisListing.total_price += all_costs.price;
                        thisListing.total_op_ex += all_costs.op_ex_per_month;
                    }
                }

                //get average cost of ownership and mortgage
                if (thisListing.total_op_ex > 0 && thisListing.count_for_sale > 0) {
                    thisListing.avg_cost = Math.round(thisListing.total_op_ex / thisListing.count_for_sale);
                    thisListing.avg_price = Math.round(thisListing.total_price / thisListing.count_for_sale);
                    thisListing.avg_mortgage = calculateMortgage((thisListing.total_price / thisListing.count_for_sale));
                }

                var exists = avg_bookings_by_bedrooms[i];
                if (!exists)
                    avg_bookings_by_bedrooms[i] = { "avg_price": 0,
                                                    "avg_bookings": 0, 
                                                    "count_homes": 0, 
                                                    "i_bedrooms": i, 
                                                    "count_for_sale": 0,
                                                    "avg_cost": 0,
                                                    "avg_mortgage": 0,
                                                }

                avg_bookings_by_bedrooms[i].avg_price = thisListing.avg_price;
                avg_bookings_by_bedrooms[i].count_for_sale = thisListing.count_for_sale;
                avg_bookings_by_bedrooms[i].avg_cost = thisListing.avg_cost;
                avg_bookings_by_bedrooms[i].avg_mortgage = thisListing.avg_mortgage;
                    
            }
            
        }

        
        var result = $.grep(avg_bookings_by_bedrooms, function(item) {
            return typeof(item) == "object";
        });
        displayAvgBookingsTable(result);
    }

    function displayAvgBookingsTable(data) {
        $('#avg_by_num_bedrooms_div').html(tmpl("avg_by_num_bedrooms_tmpl", data));
    }

    function singleHouseAnalysis(marker, display_it) {
        id = marker.id;
        address = marker.address;
        bedrooms = cleanNumber(marker.bedrooms);
        bathrooms = cleanNumber(marker.bathrooms);
        photo_url = marker.photo_url;
        sq_ft = cleanNumber(marker.sqft);
        price = cleanNumber(marker.price);
        down_payment = calculateDownPayment(price);
        closing_costs = calculateClosingCosts(price);
        furnishing_costs = calculateFurnishingCosts(price);
        total_acquisition_cost = down_payment + closing_costs + furnishing_costs;
        
        mortgage_payment = calculateMortgage(price);
        property_tax = calculatePropertyTax(price);
        mortgage_insurance = calculateMortgageInsurance(price);
        short_term_insurance = calculateShortTermInsurance(price);
        hoa = 0;
        utilities_internet = calculateUtilitiesInternet(sq_ft);
        repairs = calculateRepairs(price);
        
        revenue = getAvgBookingsByBedrooms(bedrooms);
        bookings_eighty_percent = revenue.eighty_pct;
        bookings_average = revenue.avg_bookings;
        management_fee = calculateManagementFee(bookings_eighty_percent);

        op_ex_per_month = mortgage_payment + property_tax + mortgage_insurance + short_term_insurance + hoa + utilities_internet + repairs + management_fee;
        op_ex_per_year = op_ex_per_month * 12;

        monthly_net_average = bookings_average - op_ex_per_month;
        yearly_net_average = monthly_net_average * 12;
        yearly_roi_average = calculateROI(yearly_net_average, down_payment, closing_costs, furnishing_costs);
        cap_rate_average = calculateCapRate(price, bookings_average, op_ex_per_month, mortgage_payment);

        monthly_net_80 = bookings_eighty_percent - op_ex_per_month;
        yearly_net_80 = monthly_net_80 * 12;
        yearly_roi_80 = calculateROI(yearly_net_80, down_payment, closing_costs, furnishing_costs);
        cap_rate_80 = calculateCapRate(price, bookings_eighty_percent, op_ex_per_month, mortgage_payment);


        house_object = { 
            "id": id,
            "address": address,
            "bedrooms": bedrooms,
            "bathrooms": bathrooms,
            "photo_url": photo_url,
            "sq_ft": sq_ft,
            "price": price,
            "down_payment": down_payment,
            "closing_costs": closing_costs,
            "furnishing_costs": furnishing_costs,
            "total_acquisition_cost": total_acquisition_cost,
            "bookings_average": bookings_average,
            "bookings_eighty_percent": bookings_eighty_percent,
            "mortgage_payment": mortgage_payment,
            "property_tax": property_tax,
            "mortgage_insurance": mortgage_insurance,
            "short_term_insurance": short_term_insurance,
            "utilities_internet": utilities_internet,
            "repairs": repairs,
            "management_fee": management_fee,
            "op_ex_per_month": op_ex_per_month, 
            "op_ex_per_year": op_ex_per_year,
            "monthly_net_average": monthly_net_average,
            "yearly_net_average": yearly_net_average,
            "yearly_roi_average": yearly_roi_average,
            "cap_rate_average": cap_rate_average,
            "monthly_net_80": monthly_net_80, 
            "yearly_net_80": yearly_net_80,
            "yearly_roi_80": yearly_roi_80,
            "cap_rate_80": cap_rate_80
        }

        if (display_it) {
            displayHouseAnalysis(house_object);
        }

        return house_object;
    }

    function displayHouseAnalysis(house_object) {
        $('#profit_loss_address').text(house_object.address);
        $('#profit_loss_bedrooms').text(house_object.bedrooms);
        $('#profit_loss_bathrooms').text(house_object.bathrooms);
        $('#profit_loss_sq_ft').text(displayNumber(house_object.sq_ft, 0));
        $('#profit_loss_price').text(displayNumber(house_object.price, 0, '$'));
        $('#profit_loss_down_payment').text(displayNumber(house_object.down_payment, 0, '$'));
        $('#profit_loss_closing_costs').text(displayNumber(house_object.closing_costs, 0, '$'));
        $('#profit_loss_furnishing_costs').text(displayNumber(house_object.furnishing_costs, 0, '$'));
        $('#profit_loss_total_acquisition_cost').text(displayNumber(house_object.total_acquisition_cost, 0, '$'));
        $('#profit_loss_bookings_average').text(displayNumber(house_object.bookings_average, 0, '$'));
        $('#profit_loss_bookings_eighty_percent').text(displayNumber(house_object.bookings_eighty_percent, 0, '$'));
        $('#profit_loss_mortgage_payment').text(displayNumber(house_object.mortgage_payment, 0, '$'));
        $('#profit_loss_property_tax').text(displayNumber(house_object.property_tax, 0, '$'));
        $('#profit_loss_mortgage_insurance').text(displayNumber(house_object.mortgage_insurance, 0, '$'));
        $('#profit_loss_short_term_insurance').text(displayNumber(house_object.short_term_insurance, 0, '$'));
        $('#profit_loss_utilities_internet').text(displayNumber(house_object.utilities_internet, 0, '$'));
        $('#profit_loss_repairs').text(displayNumber(house_object.repairs, 0, '$'));
        $('#profit_loss_management_fee').text(displayNumber(house_object.management_fee, 0, '$'));
        $('#profit_loss_op_ex_per_month').text(displayNumber(house_object.op_ex_per_month, 0, '$'));
        $('#profit_loss_op_ex_per_month_2').text(displayNumber(house_object.op_ex_per_month*-1, 0, '$'));
        $('#profit_loss_op_ex_per_month_3').text(displayNumber(house_object.op_ex_per_month*-1, 0, '$'));
        $('#profit_loss_op_ex_per_year').text(displayNumber(house_object.op_ex_per_year, 0, '$'));
        $('#profit_loss_monthly_net_average').text(displayNumber(house_object.monthly_net_average, 0, '$'));
        $('#profit_loss_yearly_net_average').text(displayNumber(house_object.yearly_net_average, 0, '$'));
        $('#profit_loss_yearly_roi_average').text(displayNumber(house_object.yearly_roi_average, 2, '%'));
        $('#profit_loss_cap_rate_average').text(displayNumber(house_object.cap_rate_average, 2, '%'));
        $('#profit_loss_monthly_net_80').text(displayNumber(house_object.monthly_net_80, 0, '$'));
        $('#profit_loss_yearly_net_80').text(displayNumber(house_object.yearly_net_80, 0, '$'));
        $('#profit_loss_yearly_roi_80').text(displayNumber(house_object.yearly_roi_80, 2, '%'));
        $('#profit_loss_cap_rate_80').text(displayNumber(house_object.cap_rate_80, 2, '%'));
    }

    
    /* utilFunctions */

    // house_cost = cost of house
    // down_payment_pct = down payment percent
    // loan_years = years of loan
    // interest_rate = yearly interest rate
    function calculateMortgage(house_cost, down_payment_percent, loan_years, interest_rate) {
        //default values
        if (down_payment_percent === undefined)
            down_payment_percent = 20;

        if (loan_years === undefined)
            loan_years = 30;

        if (interest_rate === undefined)
            interest_rate = 5;

        //get principle, amount of loan
        var principle = house_cost * (1 - (down_payment_percent / 100));
        //turn years into months
        var num_months = loan_years * 12;
        //turn i into a monthly interest rate
        interest_rate = interest_rate / 100 / 12;
        return Math.round(principle * interest_rate * (Math.pow(1 + interest_rate, num_months)) / (Math.pow(1 + interest_rate, num_months) - 1));
    }

    function calculateDownPayment(house_price) {
        return house_price * .2;
    }

    function calculateClosingCosts(house_price) {
        return house_price * .04;
    }

    function calculateFurnishingCosts(house_price) {
        return house_price * .15;
    }

    function calculatePropertyTax(house_price) {
        return ((house_price / 100000) * {{ place.monthly_property_tax_per_100k }});
    }

    function calculateMortgageInsurance(house_price) {
        return ((house_price / 100000) * {{ place.monthly_mortgage_insurance_per_100k }});
    }

    function calculateShortTermInsurance(house_price) {
        return ((house_price / 100000) * {{ place.monthly_short_term_insurance_per_100k }});
    }

    function calculateUtilitiesInternet(house_sqft) {
        return (house_sqft * {{ place.monthly_utilities_per_sq_ft }}) + {{ place.monthly_internet_fee }};
    }

    function calculateRepairs(house_price) {
        return (house_price * .01) / 12;
    }

    function calculateManagementFee(bookings) {
        return bookings * ({{ place.monthly_management_fee }} / 100);
    }

    function calculateROI(yearly_net_average, down_payment, closing_costs, furnishing_costs) {
        return (yearly_net_average / (down_payment + closing_costs + furnishing_costs)) * 100
    }

    function calculateCapRate(price, monthly_bookings, monthly_op_ex, monthly_mortgage) {
        //op_ex comes with mortgage cost included, but cap rate does not take
        //  mortgage into account so it needs to be deducted
        cap_rate = (((monthly_bookings - (monthly_op_ex - monthly_mortgage)) * 12) / price) * 100;
        if (cap_rate == Infinity)
            return 'n/a';
        else
            return cap_rate;
    }

    function cleanNumber(num) {
        if (num != undefined)
            return Number(num.replace(/[^0-9\.]+/g,""));
        else
            return false;
    }

    function displayNumber(num, num_decimals, display_type) {
        if (num != undefined) {
            var parts = num.toString().split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            
            if (parts[1] && num_decimals > 0) {
                parts[1] = parts[1].substring(0, num_decimals);
                parts = parts.join(".");
            }
            else
                parts = parts[0];

            if (display_type == "$")
                return "$" + parts;
            else if (display_type == "%")
                return parts + "%";
            else
                return parts;
        }
        else {
            return 0;
        }

    }

    function getAvgBookingsByBedrooms(rooms) {
        var result = $.grep(avg_bookings_by_bedrooms, function(item){
            return item.i_bedrooms == cleanNumber(rooms.toString());
        });
        if (result.length > 0)
            return result[0];
        else
            return { "eighty_pct": 0, "avg_bookings": 0 };
    }

    function getColor(bedrooms) {
        try {
            if (colors[bedrooms] !== undefined) {
                return colors[bedrooms]
            }
            else if (colors[bedrooms.substring(0,1)] !== undefined) {
                return colors[bedrooms.substring(0,1)];
            }
            else {
                return colors[0];
            }
        }
        catch (e) {
            return colors[0];
        }
        
    }

    </script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key_js_map }}">
    </script>
    <script>
    $(document).ready(function() {
        //getListings();
        initMap();
    });
    </script>

    <br />
    

{% endblock %}