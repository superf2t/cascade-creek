{% extends "layout.html" %}
{% block css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chartist.min.css') }}">
    <script src="{{ url_for('static', filename='js/chartist.min.js') }}"></script>
    
    <style>
    #map {
        height: 500px;
        width: 100%;
    }
    #for_sale_listings_container {
        height: 500px;
        overflow-y: scroll;
        padding: 0;
    }
    
    .table > tbody > tr > td {
        vertical-align: middle;
    }
    
    .w180 { width: 180px; }
    table.td-right td { text-align: right; }
    .smallme tbody tr th { padding: 2px; }
    .smallme tbody tr td { padding: 2px; }

    .bottom-line { border-bottom: solid 1px #cccccc; }

    
    .ct-series-a .ct-line, .ct-series-a .ct-point { stroke: {{ colors[0] }}; }
    .ct-series-b .ct-line, .ct-series-b .ct-point { stroke: {{ colors[1] }}; }
    .ct-series-c .ct-line, .ct-series-c .ct-point { stroke: {{ colors[2] }}; }
    .ct-series-d .ct-line, .ct-series-d .ct-point { stroke: {{ colors[3] }}; }
    .ct-series-e .ct-line, .ct-series-e .ct-point { stroke: {{ colors[4] }}; }
    
    </style>
{% endblock %}
{% block body %}

    <h1>{{ place.name }} &nbsp;&nbsp;&nbsp;<small>
        {% if current_user.id == 'travis' %}
            <a href="/place/view_place/{{ place.place_id }}/queue" class="btn btn-primary">Scrape Airbnb</a></small>
        {% endif %}
    </h1>

    <div class="row" style="margin-bottom: 10px">
        <div class="col-sm-4">
            <h3><span id="listing_count">{{ place.listing_count }}</span> Listings</h3>
            {{ place.total_months_of_data }} months of data, last updated on {{ place.last_update }}
        </div>
        <div class="col-sm-8">
            <br />
            <small>Filter "For Sale" results:</small>
            <form class="form-inline">
                <select class="form-control" id="min_bedroom_count" onchange="filterForSale()">
                <option value="0" selected>Min beds</option>
                <option value="1">1 bed</option>
                <option value="2">2 beds</option>
                <option value="3">3 beds</option>
                <option value="4">4 beds</option>
                <option value="5">5 beds</option>
                <option value="6">6 beds</option>
                </select>
                &nbsp;
                <select class="form-control" id="max_bedroom_count" onchange="filterForSale()">
                <option value="1">1 bed</option>
                <option value="2">2 beds</option>
                <option value="3">3 beds</option>
                <option value="4">4 beds</option>
                <option value="5">5 beds</option>
                <option value="6">6 beds</option>
                <option value="*" selected>Max beds</option>
                </select>
                &nbsp;&nbsp;
                <select class="form-control" id="max_price" onchange="filterForSale()">
                <option value="100000">$100k max</option>
                <option value="150000">$150k max</option>
                <option value="200000">$200k max</option>
                <option value="250000">$250k max</option>
                <option value="300000">$300k max</option>
                <option value="350000">$350k max</option>
                <option value="400000">$400k max</option>
                <option value="450000">$450k max</option>
                <option value="500000">$500k max</option>
                <option value="*" selected>Max price</option>
                </select>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-md-9"><div id="map"></div></div>
        <div class="col-md-3" id="for_sale_listings_container">
            <table id="for_sale_listings" class="table table-striped table-condensed">
            <tr>
                <th>&nbsp;</th>
                <th>Bed/Bath</th>
                <th>Price</th>
                <th>Cap</th>
            </tr>
            </table>
        </div>
    </div>
    
    <h3>Monthly Average by Num Bedrooms</h3>
    <table class="table table-striped">
    <tr>
        <th align="center">Bedrooms</th>
        <th align="center"># Airbnb's</th>
        <th align="center"># For Sale</th>
        <th align="center">Price</th>
        <th align="center">Cost/Mo</th>
        <th align="center">Rate</th>
        <th align="center">Num Nights</th>
        <th align="center">Rev/Mo</th>
        <th align="center">80% Rev/Mo</th>
        <th align="center">Cap Rate (80%)</th>
        <th align="center">ROI (80%)</th>
    </tr>
    <tr id="bedrooms_0">
        <td align="center" id="bedrooms_0_count_bedrooms">0</td>
        <td align="center" id="bedrooms_0_count_homes">-</td>
        <td align="center" id="bedrooms_0_count_for_sale">-</td>
        <td align="center" id="bedrooms_0_avg_price">-</td>
        <td align="center" id="bedrooms_0_avg_cost">-</td>
        <td align="center" id="bedrooms_0_avg_rate">-</td>
        <td align="center" id="bedrooms_0_avg_num_nights">-</td>
        <td align="center" id="bedrooms_0_avg_bookings">-</td>
        <td align="center" id="bedrooms_0_eighty_pct">-</td>
        <td align="center" id="bedrooms_0_cap_rate">-</td>
        <td align="center" id="bedrooms_0_yearly_roi">-</td>
    </tr>
    <tr id="bedrooms_1">
        <td align="center" id="bedrooms_1_count_bedrooms">1</td>
        <td align="center" id="bedrooms_1_count_homes">-</td>
        <td align="center" id="bedrooms_1_count_for_sale">-</td>
        <td align="center" id="bedrooms_1_avg_price">-</td>
        <td align="center" id="bedrooms_1_avg_cost">-</td>
        <td align="center" id="bedrooms_1_avg_rate">-</td>
        <td align="center" id="bedrooms_1_avg_num_nights">-</td>
        <td align="center" id="bedrooms_1_avg_bookings">-</td>
        <td align="center" id="bedrooms_1_eighty_pct">-</td>
        <td align="center" id="bedrooms_1_cap_rate">-</td>
        <td align="center" id="bedrooms_1_yearly_roi">-</td>
    </tr>
    <tr id="bedrooms_2">
        <td align="center" id="bedrooms_2_count_bedrooms">2</td>
        <td align="center" id="bedrooms_2_count_homes">-</td>
        <td align="center" id="bedrooms_2_count_for_sale">-</td>
        <td align="center" id="bedrooms_2_avg_price">-</td>
        <td align="center" id="bedrooms_2_avg_cost">-</td>
        <td align="center" id="bedrooms_2_avg_rate">-</td>
        <td align="center" id="bedrooms_2_avg_num_nights">-</td>
        <td align="center" id="bedrooms_2_avg_bookings">-</td>
        <td align="center" id="bedrooms_2_eighty_pct">-</td>
        <td align="center" id="bedrooms_2_cap_rate">-</td>
        <td align="center" id="bedrooms_2_yearly_roi">-</td>
    </tr>
    <tr id="bedrooms_3">
        <td align="center" id="bedrooms_3_count_bedrooms">3</td>
        <td align="center" id="bedrooms_3_count_homes">-</td>
        <td align="center" id="bedrooms_3_count_for_sale">-</td>
        <td align="center" id="bedrooms_3_avg_price">-</td>
        <td align="center" id="bedrooms_3_avg_cost">-</td>
        <td align="center" id="bedrooms_3_avg_rate">-</td>
        <td align="center" id="bedrooms_3_avg_num_nights">-</td>
        <td align="center" id="bedrooms_3_avg_bookings">-</td>
        <td align="center" id="bedrooms_3_eighty_pct">-</td>
        <td align="center" id="bedrooms_3_cap_rate">-</td>
        <td align="center" id="bedrooms_3_yearly_roi">-</td>
    </tr>
    <tr id="bedrooms_4">
        <td align="center" id="bedrooms_4_count_bedrooms">4</td>
        <td align="center" id="bedrooms_4_count_homes">-</td>
        <td align="center" id="bedrooms_4_count_for_sale">-</td>
        <td align="center" id="bedrooms_4_avg_price">-</td>
        <td align="center" id="bedrooms_4_avg_cost">-</td>
        <td align="center" id="bedrooms_4_avg_rate">-</td>
        <td align="center" id="bedrooms_4_avg_num_nights">-</td>
        <td align="center" id="bedrooms_4_avg_bookings">-</td>
        <td align="center" id="bedrooms_4_eighty_pct">-</td>
        <td align="center" id="bedrooms_4_cap_rate">-</td>
        <td align="center" id="bedrooms_4_yearly_roi">-</td>
    </tr>
    <tr id="bedrooms_5">
        <td align="center" id="bedrooms_5_count_bedrooms">5</td>
        <td align="center" id="bedrooms_5_count_homes">-</td>
        <td align="center" id="bedrooms_5_count_for_sale">-</td>
        <td align="center" id="bedrooms_5_avg_price">-</td>
        <td align="center" id="bedrooms_5_avg_cost">-</td>
        <td align="center" id="bedrooms_5_avg_rate">-</td>
        <td align="center" id="bedrooms_5_avg_num_nights">-</td>
        <td align="center" id="bedrooms_5_avg_bookings">-</td>
        <td align="center" id="bedrooms_5_eighty_pct">-</td>
        <td align="center" id="bedrooms_5_cap_rate">-</td>
        <td align="center" id="bedrooms_5_yearly_roi">-</td>
    </tr>
    <tr id="bedrooms_6">
        <td align="center" id="bedrooms_6_count_bedrooms">6</td>
        <td align="center" id="bedrooms_6_count_homes">-</td>
        <td align="center" id="bedrooms_6_count_for_sale">-</td>
        <td align="center" id="bedrooms_6_avg_price">-</td>
        <td align="center" id="bedrooms_6_avg_cost">-</td>
        <td align="center" id="bedrooms_6_avg_rate">-</td>
        <td align="center" id="bedrooms_6_avg_num_nights">-</td>
        <td align="center" id="bedrooms_6_avg_bookings">-</td>
        <td align="center" id="bedrooms_6_eighty_pct">-</td>
        <td align="center" id="bedrooms_6_cap_rate">-</td>
        <td align="center" id="bedrooms_6_yearly_roi">-</td>
    </tr>
    </table>

    <h3>Average Number of Nights Booked Per Month</h3>
    <div id="average_number_of_nights_booked_chart"></div>

    <h3>Average Price Per Night</h3>
    <div id="average_price_per_night_chart"></div>
    
    <form>
    <h3>Monthly Ownership Costs</h3>
    <div class="alert alert-success" style="display: none;" id="monthly_ownership_costs_message"></div>
    <table class="table">
        <tr>
            <th>Monthly Management Fee %</th>
            <td class="w180">
                <div class="input-group">
                    <input type="text" class="form-control" id="monthly_management_fee" placeholder="Percent" value="{{ place.monthly_management_fee }}">
                    <div class="input-group-addon">%</div>
                </div>
            </td>
        </tr>
        <tr>
            <th>Monthly Property Tax/$100k</th>
            <td class="w180">
                <div class="input-group">
                    <div class="input-group-addon">$</div>
                    <input type="text" class="form-control" id="monthly_property_tax_per_100k" placeholder="Amount" value="{{ place.monthly_property_tax_per_100k }}">
                </div>
            </td>
        </tr>
        <tr>
            <th>Monthly Mortgage Insurance/$100k</th>
            <td class="w180">
                <div class="input-group">
                    <div class="input-group-addon">$</div>
                    <input type="text" class="form-control" id="monthly_mortgage_insurance_per_100k" placeholder="Amount" value="{{ place.monthly_mortgage_insurance_per_100k }}">
                </div>
            </td>
        </tr>
        <tr>
            <th>Monthly Short Term Insurance/$100k</th>
            <td class="w180">
                <div class="input-group">
                    <div class="input-group-addon">$</div>
                    <input type="text" class="form-control" id="monthly_short_term_insurance_per_100k" placeholder="Amount" value="{{ place.monthly_short_term_insurance_per_100k }}">
                </div>
            </td>
        </tr>
        <tr>
            <th>Monthly Utilities/1 sq/ft</th>
            <td class="w180">
                <div class="input-group">
                    <div class="input-group-addon">$</div>
                    <input type="text" class="form-control" id="monthly_utilities_per_sq_ft" placeholder="Amount" value="{{ place.monthly_utilities_per_sq_ft }}">
                </div>
            </td>
        </tr>
        <tr>
            <th>Monthly Internet Service</th>
            <td class="w180">
                <div class="input-group">
                    <div class="input-group-addon">$</div>
                    <input type="text" class="form-control" id="monthly_internet_fee" placeholder="Amount" value="{{ place.monthly_internet_fee }}">
                </div>
            </td>
        </tr>
        <tr>
        <th>&nbsp;</th>
        <td><input type="button" class="btn btn-primary" id="submit_monthly_fee_form" onclick="handle_submit_monthly_fee_form()" value="Submit"></td>
        </tr>
    </table>
    </form>


    {% raw %}
    <script type="text/x-tmpl" id="for_sale_houses_tmpl">
        <tr id="{%= o.id %}" data-cap="{%= displayNumber(o.cap_rate_average, 1) %}" 
            onclick="google.maps.event.trigger(forSaleMarkers[{%= o.id %}], 'click');" 
            onmouseover="javascript:forSaleMarkers[{%= o.id %}].setAnimation(google.maps.Animation.BOUNCE);" 
            onmouseout="javascript:forSaleMarkers[{%= o.id %}].setAnimation(-1);;">
                <td><img src="https://thumbs.trulia-cdn.com{%= o.photo_url %}" width="50" /></td>
                <td>{%= o.bedrooms + '/' + o.bathrooms %}</td>
                <td>{%= o.short_price %}</td>
                <td>{%= displayNumber(o.cap_rate_average, 1, '%') %}</td>
        </tr>
    </script>
    {% endraw %}


    <div class="modal fade" id="modal_house_analysis">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    
                    <div class="row">
                        <div class="col-sm-12 text-center">
                            <h3>Proforma for <span id="profit_loss_address"></span></h3>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4 text-center">
                            <h5>Bedrooms: <span id="profit_loss_bedrooms"></span></h5>
                        </div>
                        <div class="col-sm-4 text-center">
                            <h5>Bathrooms: <span id="profit_loss_bathrooms"></span></h5>
                        </div>
                        <div class="col-sm-4 text-center">
                            <h5>Sq/Ft: <span id="profit_loss_sq_ft"></span></h5>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-sm-12"><h4>Acquisition</h4></div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Price:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_price"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Down payment:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_down_payment"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Closing costs:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_closing_costs"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1 bottom-line">Furnishing costs:</div>
                        <div class="col-sm-2 text-right bottom-line">
                            <span id="profit_loss_furnishing_costs"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Total acquisition cost:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_total_acquisition_cost"></span></b>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-12"><h4>Costs</h4></div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Mortgage payment:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_mortgage_payment"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Property tax:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_property_tax"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Mortgage insurance:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_mortgage_insurance"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Short Term Insurance:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_short_term_insurance"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">HOA:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_hoa">???</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Utilities + Internet:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_utilities_internet"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Repairs:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_repairs"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1 bottom-line">Management Fee:</div>
                        <div class="col-sm-2 text-right bottom-line">
                            <span id="profit_loss_management_fee"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Monthly Operating Expense:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_op_ex_per_month"></span></b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Annual Operating Expense:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_op_ex_per_year"></span></b>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-12"><h4>Average Return</h4></div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">Monthly Average Revenue:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_bookings_average"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1 bottom-line">Monthly Operating Expense:</div>
                        <div class="col-sm-2 text-right bottom-line">
                            <span id="profit_loss_op_ex_per_month_2"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Monthly Net Profit:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_monthly_net_average"></span></b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Annual net profit:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_yearly_net_average"></span></b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Annual ROI:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_yearly_roi_average"></span></b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Cap rate:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_cap_rate_average"></span></b>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-12"><h4>80th Percentile Return</h4></div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">80th% Revenue:</div>
                        <div class="col-sm-2 text-right">
                            <span id="profit_loss_bookings_eighty_percent"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1 bottom-line">Monthly Operating Expense:</div>
                        <div class="col-sm-2 text-right bottom-line">
                            <span id="profit_loss_op_ex_per_month_3"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Monthly net profit:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_monthly_net_80"></span></b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Annual net profit:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_yearly_net_80"></span></b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Annual ROI:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_yearly_roi_80"></span></b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1"><b>Cap rate:</b></div>
                        <div class="col-sm-2 text-right">
                            <b><span id="profit_loss_cap_rate_80"></span></b>
                        </div>
                    </div>
                    
                </div> <!-- /.modal-body -->
            </div> <!-- /.modal-content -->
        </div> <!-- /.modal-dialog -->
    </div>


    <script>
    var map = null;
    var avg_bookings_by_bedrooms = [];
    var airbnbMarkers = [];
    var forSaleMarkers = [];
    var colors = {{ colors|tojson }};

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 3
        });

        var rectangle = new google.maps.Rectangle({
            strokeColor: '#FF0000',
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: '#000000',
            fillOpacity: 0,
            map: map,
            bounds: {
                north: {{ place.ne_lat }},
                south: {{ place.sw_lat }},
                east: {{ place.ne_lng }},
                west: {{ place.sw_lng }}
            }
        });

        var bounds = new google.maps.LatLngBounds();
        bounds.extend(new google.maps.LatLng({{ place.ne_lat }}, {{ place.ne_lng }}))
        bounds.extend(new google.maps.LatLng({{ place.sw_lat }}, {{ place.sw_lng}}))
        map.fitBounds(bounds);

        updateMap('{{ place.place_id }}', {{ place.ne_lat }}, {{ place.ne_lng }}, {{ place.sw_lat }}, {{ place.sw_lng}});

        //wait a second before adding listeners so they don't fire while loading page
        setTimeout(function(){ 
            map.addListener('dragend', function() {
                ne = map.getBounds().getNorthEast();
                sw = map.getBounds().getSouthWest();
                updateMap('{{ place.place_id }}', ne.lat(), ne.lng(), sw.lat(), sw.lng());
            });
            
            map.addListener('zoom_changed', function() {
                ne = map.getBounds().getNorthEast();
                sw = map.getBounds().getSouthWest();
                updateMap('{{ place.place_id }}', ne.lat(), ne.lng(), sw.lat(), sw.lng());
            }); 
        }, 1000);
        
    }

    function updateMap(place_id, ne_lat, ne_lng, sw_lat, sw_lng) {
        clearMarkers();

        getAvgBookingsByBedroomByLat(place_id, ne_lat, ne_lng, sw_lat, sw_lng, function() {

            getAirbnbListings(place_id, ne_lat, ne_lng, sw_lat, sw_lng, function() {

                let min_beds = $('#min_bedroom_count').val();
                let max_beds = $('#max_bedroom_count').val();
                let max_price = $('#max_price').val();
                getForSale(ne_lat, ne_lng, sw_lat, sw_lng, min_beds, max_beds, max_price, function() {

                    updateAvgCostAnalysis();

                    getMonthlyAveragePriceAndBookings(place_id, ne_lat, ne_lng, sw_lat, sw_lng);

                });
            });
        });
    }

    function donenow() { console.log('done'); }


    /* ajaxFunctions */
    function getAvgBookingsByBedroomByLat(place_id, ne_lat, ne_lng, sw_lat, sw_lng, callback) {
        $.getJSON('/place/_get_avg_bookings_by_bedroom/' + place_id + '/' + ne_lat + '/' + ne_lng + '/' + sw_lat + '/' + sw_lng, function(abbb) {
                avg_bookings_by_bedrooms = abbb;
                callback();
        });
    }

    function getAirbnbListings (place_id, ne_lat, ne_lng, sw_lat, sw_lng, callback) {
        $.getJSON('/place/_listings_geojson/' + place_id + '/' + ne_lat + '/' + ne_lng + '/' + sw_lat + '/' + sw_lng, function(listings) {

            for (i = 0; i < listings.length; i++) {

                var latLng = new google.maps.LatLng(listings[i]['lat'], listings[i]['lng'])
                //bounds.extend(latLng)

                var marker = new google.maps.Marker({
                    map: map,
                    position: latLng,
                    clickable: true,
                    icon: getCircle(listings[i]['count_nights_rank'], listings[i]['total_bookings_rank'], getColor(listings[i]['bedrooms']))
                });
                marker.note = '<div>' + 
                                '<table width="100%"><tr>' +
                                '<td align="center" style="padding-right: 20px;">' +
                                    '<h3 style="margin-top: 0;"><a href="https://www.airbnb.com/rooms/' + listings[i]['listing_id'] + '" target="_new">' + listings[i]['name'] + '</a></h3>' +
                                    '<img src="' + listings[i]['picture_url'] + '" height="180" style="margin-left: 15px;">' +
                                '</td>' +
                                '<td style="margin-top: 30px;">' +
                                    '<table class="table table-striped smallme">' +
                                    '<tr><th>Beds/Baths:</th><td> ' + listings[i]['bedrooms'] + '/' + listings[i]['bathrooms'] + '</td></tr>' +
                                    '<tr><th>Nightly Rate:</th><td>' + listings[i]['rate'] + '</td></tr>' +
                                    '<tr><th>Star rating:</th><td> ' + listings[i]['star_rating'] + '</td></tr>' +
                                    '<tr><th>Num reviews:</th><td> ' + listings[i]['count_reviews'] + '</td></tr>' +
                                    '<tr><th>Beds:</th><td> ' + listings[i]['beds'] + '</td></tr>' +
                                    '<tr><th>Person capacity:</th><td> ' + listings[i]['person_capacity'] + '</td></tr>' +
                                    '<tr><th>Avg Nights Per Month:</th><td>' + listings[i]['avg_num_nights'] + '</td></tr>' + 
                                    '<tr><th>Avg Monthly Bookings:</th><td> $' + listings[i]['avg_monthly_bookings'] + '</td></tr>' + 
                                    '</table>' +
                                '</td>' +
                                '</tr></table>' +
                                '</div>';

                airbnbMarkers.push(marker);

                var infoWindow = new google.maps.InfoWindow();

                marker.addListener('click', function() {
                    infoWindow.setContent(this.note);
                    infoWindow.open(this.getMap(), this);
                });

            };

            callback();

        });
   
    }

    nightsobj = [];
    function getMonthlyAveragePriceAndBookings(place_id, ne_lat, ne_lng, sw_lat, sw_lng) {
        $.getJSON('/place/_get_nights_and_bookings_by_month_api/' + place_id + '/' + ne_lat + '/' + ne_lng + '/' + sw_lat + '/' + sw_lng, function(nights_and_bookings_by_month) {

            //First get unique list of number of bedrooms
            //Then create an array of the dates for 1 bedroom
            //Then create an array of arrays for each of 
            //  average_nights_booked_per_month
            //  average_price_per_night
            
            //create a unique array for bedrooms
            const arr_bedrooms = [0, 1, 2, 3, 4, 5]
            //create a unique array for 1 bedroom dates
            const arr_unique_dates = [...new Set(nights_and_bookings_by_month.map(item => item.booking_month))];

            //create an array of arrays for average_nights_booked_per_month
            var arr_avg_nights_per_month = [];
            var arr_avg_price_per_month = [];

            //loop through all bedrooms
            arr_bedrooms.forEach(function(bedrooms_element)  {
                arr_avg_nights_per_month.push([]);
                arr_avg_price_per_month.push([]);

                //loop through each date
                arr_unique_dates.forEach(function(dates_element) {

                    //get the one object with this combo of bedrooms and date
                    let arr_temp = nights_and_bookings_by_month.find(
                        x => x.i_bedrooms === bedrooms_element && x.booking_month === dates_element
                    );

                    try {
                        //and populate the individual arrays
                        arr_avg_nights_per_month[arr_avg_nights_per_month.length - 1].push(arr_temp.average_nights_booked_per_month);
                        arr_avg_price_per_month[arr_avg_price_per_month.length - 1].push(arr_temp.average_price_per_night);
                    }
                    catch(err) {
                        console.log('Error: ' + err.message);
                        arr_avg_nights_per_month[arr_avg_nights_per_month.length - 1].push(null);
                        arr_avg_price_per_month[arr_avg_price_per_month.length - 1].push(null);
                    }
                    
                });
            });


            var data = {
              // A labels array that can contain any sort of values
              labels: arr_unique_dates,
              // Our series array that contains series objects or in this case series data arrays
              series: arr_avg_nights_per_month
            };

            new Chartist.Line('#average_number_of_nights_booked_chart', data);

            var data = {
              // A labels array that can contain any sort of values
              labels: arr_unique_dates,
              // Our series array that contains series objects or in this case series data arrays
              series: arr_avg_price_per_month
            };            
            new Chartist.Line('#average_price_per_night_chart', data)
        })

    }

    function getForSale(ne_lat, ne_lng, sw_lat, sw_lng, min_beds, max_beds, max_price, callback) {

        //empty the scroller
        $('#for_sale_listings').find("tr:gt(0)").remove();

        //get some for sale listings in this area
        $.getJSON('/place/_for_sale/' + ne_lat + '/' + ne_lng + '/' + sw_lat + '/' + sw_lng + '/' + min_beds + '/' + max_beds + '/' + max_price, function(results) {
    
            if (results.success != false) {
                //loop and put markers on screen
                for (var i = 0; i < results.page.cards.length; i++) {
                    
                    card = results.page.cards[i];

                    if (card.beds !== undefined) {

                        offset = Math.random() / 5000;
                        offset2 = Math.random() / 5000;

                        var latLng = new google.maps.LatLng(card.latLng[0] + offset, card.latLng[1] + offset2);

                        var marker = new google.maps.Marker({
                            map: map,
                            position: latLng,
                            icon: {
                                path: google.maps.SymbolPath.FORWARD_OPEN_ARROW,
                                scale: 2,
                                labelOrigin: new google.maps.Point(0, 8),
                                strokeColor: getColor(card.beds)
                            },
                            label: {
                                text: 'wait for it...',
                                color: getColor(card.beds),
                                fontSize: '10px'
                            },
                            address: card.streetAddress,
                            bedrooms: card.beds,
                            bathrooms: card.baths,
                            price: card.price,
                            short_price: card.shortPrice,
                            sqft: card.sqft,
                            photo_url: card.photoUrl,
                            id: forSaleMarkers.length
                        });

                        house_analysis = singleHouseAnalysis(marker);
                        this_bookings = getAvgBookingsByBedrooms(card.beds);
                        avg_bookings_80 = this_bookings.eighty_pct;

                        marker.label.text = card.shortPrice + '(' + displayNumber(house_analysis.cap_rate_80, 2, "%") + ')';
                        marker.cap_rate_80 = house_analysis.cap_rate_80;
                        marker.cap_rate_average = house_analysis.cap_rate_average;

                        marker.note = '<div>' +
                                        '<table width="100%"><tr>' +
                                        '<td align="center" style="padding-right: 20px;">' +
                                            '<h3 style="margin-top: 0;"><a href="https://www.trulia.com' + card.cardUrl + '" target="_new">' + card.streetAddress + '</a></h3>' +
                                            '<img src="https://thumbs.trulia-cdn.com' + card.photoUrl + '" height="180" style="margin-left: 15px;"></td>' +
                                        '<td style="padding-top: 30px;">' +
                                            '<table class="table table-striped smallme">' +
                                            '<tr><th>Beds/Baths:</th><td>' + card.beds + ' / ' + card.baths + '</td></tr>' +
                                            '<tr><th>Sq/ft:</th><td>' + card.sqft + '</td></tr>' +
                                            '<tr><th>Location:</th><td>' + card.footer.location + '</td></tr>' +
                                            '<tr><th>Price:</th><td>' + card.price + '</td></tr>' +
                                            '<tr><th>Revenue/mo:</th><td>' + displayNumber(avg_bookings_80, 0, "$") + '</td></tr>' +
                                            '<tr><th>Cost/mo:</th><td>' + displayNumber(house_analysis.op_ex_per_month, 0, "$") + '</td></tr>' +
                                            '<tr><th>Net profit/mo:</th><td>' + displayNumber(avg_bookings_80 - house_analysis.op_ex_per_month, 0, "$") + '</td></tr>' +
                                            '<tr><th>ROI:</th><td>' + displayNumber(house_analysis.yearly_roi_80, 2, "%") + '</td></tr>' +
                                            '<tr><th>Cap rate (avg):</th><td>' + displayNumber(house_analysis.cap_rate_average, 2, "%") + '</td></tr>' +
                                            '<tr><th>Cap rate (80th%):</th><td>' + displayNumber(house_analysis.cap_rate_80, 2, "%") + '</td></tr>' +
                                            '<tr><th colspan="2" align="right"><a href="#modal_house_analysis" data-toggle="modal">Details</a></th></tr>' +
                                            '</table>' +
                                        '</td>' +
                                        '</tr></table>' +
                                      '</div>';

                        forSaleMarkers.push(marker);
                        
                        var infoWindow = new google.maps.InfoWindow();

                        marker.addListener('click', function() {
                            infoWindow.setContent(this.note);
                            infoWindow.open(this.getMap(), this);
                            singleHouseAnalysis(this, true);
                        });

                        //populate the scroller with this house info
                        populateScroller(marker);

                    }

                }

            }
            else {
                console.log('results.page.cards is undefined. Here is results:\n' + JSON.stringify(results) + '\n');

                $('#for_sale_listings tr:last').after("<tr><td colspan='3'>No results returned</td></tr>");
            }

            callback();

        });

    }

    //populate the scroller in order by cap rate desc
    function populateScroller(marker) {
        //$('#for_sale_listings')
        //tmpl("for_sale_houses_tmpl", marker)
        //let cap_rate = marker.cap_rate_80;
        let cap_rate = marker.cap_rate_average;
        
        //get data attribute values of existing tr's and read into array
        var dataList = $("#for_sale_listings tr[data-cap]").map(function() {
            return parseFloat($(this).data("cap"), 1);
        }).get();

        //if no rows are added yet, add it
        if (dataList.length == 0) {
            $('#for_sale_listings tr:last').after(
                tmpl("for_sale_houses_tmpl", marker)
            );
        }
        else {
            //loop through, find the first one this is smaller than, and insert
            for (var i = 0; i < dataList.length; i++) {
                if (cap_rate > dataList[i]) {
                    //$('#for_sale_listings tr[data-cap="' + dataList[i] + '"').before(
                    $('#for_sale_listings tr[data-cap]').eq(i).before(
                        tmpl("for_sale_houses_tmpl", marker)
                    );
                    i = 999;
                }
            }
            //if this is the smallest of the bunch, put it at the end
            if (i < 999) {
                $('#for_sale_listings tr:last').after(
                    tmpl("for_sale_houses_tmpl", marker)
                );       
            }


        }
        

    }

    /* handle monthly costs form submit */
    function handle_submit_monthly_fee_form() {
        var monthly_property_tax_per_100k = $('#monthly_property_tax_per_100k').val();
        var monthly_mortgage_insurance_per_100k = $('#monthly_mortgage_insurance_per_100k').val();
        var monthly_short_term_insurance_per_100k = $('#monthly_short_term_insurance_per_100k').val();
        var monthly_utilities_per_sq_ft = $('#monthly_utilities_per_sq_ft').val();
        var monthly_internet_fee = $('#monthly_internet_fee').val();
        var monthly_management_fee = $('#monthly_management_fee').val();

        querystring = 'monthly_property_tax_per_100k=' + monthly_property_tax_per_100k +
                        '&monthly_mortgage_insurance_per_100k=' + monthly_mortgage_insurance_per_100k +
                        '&monthly_short_term_insurance_per_100k=' + monthly_short_term_insurance_per_100k +
                        '&monthly_utilities_per_sq_ft=' + monthly_utilities_per_sq_ft +
                        '&monthly_internet_fee=' + monthly_internet_fee +
                        '&monthly_management_fee=' + monthly_management_fee


        $.getJSON('/place/_submit_monthly_fee_form/{{ place.place_id }}?' + querystring, function(result) {
            $('#monthly_ownership_costs_message').html(result);
            $('#monthly_ownership_costs_message').show();
            setTimeout(function(){ 
                $('#monthly_ownership_costs_message').hide();
            }, 3000);
        });
    }

    function filterForSale() {
        let min_beds = $('#min_bedroom_count').val();
        let max_beds = $('#max_bedroom_count').val();
        let max_price = $('#max_price').val();
        let ne = map.getBounds().getNorthEast();
        let sw = map.getBounds().getSouthWest();

        clearForSaleMarkers();
        getForSale(ne.lat(), ne.lng(), sw.lat(), sw.lng(), min_beds, max_beds, max_price, function() {

            updateAvgCostAnalysis();

        });
    }

        
    /* displayFunctions */

    function getCircle(count_nights_rank, total_bookings_rank, color) {
        return {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: color,
            fillOpacity: Number(total_bookings_rank) / 100, //.2,
            scale: Math.sqrt(count_nights_rank), //Math.pow(2, count_nights_rank) / 2,
            strokeColor: 'white',
            strokeWeight: .5
        };
    }

    function clearMarkers() {
        clearForSaleMarkers();
        clearAirbnbMarkers();
    }
    function clearForSaleMarkers() {
        for (var i = 0; i < forSaleMarkers.length; i++) {
            forSaleMarkers[i].setMap(null);
        }
        forSaleMarkers = [];
    }
    function clearAirbnbMarkers() {
        for (var i = 0; i < airbnbMarkers.length; i++) {
            airbnbMarkers[i].setMap(null);
        }
        airbnbMarkers = [];
    }

    function clearCostAnalysis(bedroom_count) {
        $('#bedrooms_' + bedroom_count + '_count_homes').html('-');
        $('#bedrooms_' + bedroom_count + '_avg_bookings').html('-');
        $('#bedrooms_' + bedroom_count + '_eighty_pct').html('-');
        $('#bedrooms_' + bedroom_count + '_count_for_sale').html('-');
        $('#bedrooms_' + bedroom_count + '_avg_price').html('-');
        $('#bedrooms_' + bedroom_count + '_avg_cost').html('-');
        $('#bedrooms_' + bedroom_count + '_avg_rate').html('-');
        $('#bedrooms_' + bedroom_count + '_avg_num_nights').html('-');
        $('#bedrooms_' + bedroom_count + '_cap_rate').removeClass().html('-');
        $('#bedrooms_' + bedroom_count + '_yearly_roi').removeClass().html('-');
    }


    //loop through the forSaleMarkers array and update the average monthly table
    function updateAvgCostAnalysis() {

        //loop through 0-6 bedroom houses and update total num houses and total cost
        for (i = 0; i <= 6; i++) {
            //clear out what is currently on the cost analysis
            clearCostAnalysis(i);

            updateAvgCostAirbnbListings(i);
            updateAvgCostForSaleListings(i);
        }

        //update total houses
        $('#listing_count').html(avg_bookings_by_bedrooms[avg_bookings_by_bedrooms.length-1].count_homes)

    }

    function updateAvgCostAirbnbListings(bedroom_count) {

        //update background color
        $('#bedrooms_' + bedroom_count + '_count_bedrooms').css('background-color', getColor(bedroom_count));

        var result = $.grep(avg_bookings_by_bedrooms, function(item) {
            return item.i_bedrooms == bedroom_count;
        });

        if (result.length > 0) {
            $('#bedrooms_' + bedroom_count + '_count_homes').html(result[0].count_homes);
            $('#bedrooms_' + bedroom_count + '_avg_rate').html(displayNumber(result[0].avg_price_per_night, 0, '$'));
            $('#bedrooms_' + bedroom_count + '_avg_num_nights').html(result[0].avg_num_nights);
            $('#bedrooms_' + bedroom_count + '_avg_bookings').html(displayNumber(result[0].avg_bookings, 0, '$'));
            $('#bedrooms_' + bedroom_count + '_eighty_pct').html(displayNumber(result[0].eighty_pct, 0, '$'));
        }
        
    }

    function updateAvgCostForSaleListings(bedroom_count) {

        //grab all the x bedroom houses and put into array
        var forSaleResults = $.grep(forSaleMarkers, function(item){
            return item.bedrooms == bedroom_count + 'bd';
        });

        //if there are airbnb's in this area, get their aggregated values
        var airbnbListingResults = $.grep(avg_bookings_by_bedrooms, function(item) {
            return item.i_bedrooms == bedroom_count;
        });

        if (forSaleResults.length > 0) {
            var thisListing = {
                                "count_for_sale": 0, 
                                "total_op_ex": 0, 
                                "total_price": 0, 
                                "avg_price": 0, 
                                "avg_num_nights": 0,
                                "avg_mortgage": 0
                            };

            //loop through all houses with this many bedrooms and update the dictionary
            for (j = 0; j < forSaleResults.length; j++) {

                //only try to calculate the forSaleResults if this is a number
                if ($.isNumeric(forSaleResults[j].price.replace(/[^0-9\.]+/g,""))) {
                    thisListing.count_for_sale += 1;

                    let all_costs = singleHouseAnalysis(forSaleResults[j], false);
                    thisListing.total_price += all_costs.price;
                    thisListing.total_op_ex += all_costs.op_ex_per_month;
                }


            }

            //get average cost of ownership and mortgage
            if (thisListing.total_op_ex > 0 && thisListing.count_for_sale > 0) {

                thisListing.avg_cost = Math.round(thisListing.total_op_ex / thisListing.count_for_sale);
                thisListing.avg_price = Math.round(thisListing.total_price / thisListing.count_for_sale);
                thisListing.avg_mortgage = calculateMortgage((thisListing.total_price / thisListing.count_for_sale));
            }

            down_payment = calculateDownPayment(thisListing.avg_price);
            closing_costs = calculateClosingCosts(thisListing.avg_price);
            furnishing_costs = calculateFurnishingCosts(thisListing.avg_price);
            
            if (airbnbListingResults.length > 0) {
                yearly_net_80 = (airbnbListingResults[0].eighty_pct - thisListing.avg_cost) * 12;
                yearly_roi_80 = calculateROI(yearly_net_80, down_payment, closing_costs, furnishing_costs);
                cap_rate_80 = calculateCapRate(thisListing.avg_price, airbnbListingResults[0].eighty_pct, thisListing.avg_cost, thisListing.avg_mortgage);
            }
            
            let td_class = "";
            if (cap_rate_80 > 10) {
                td_class = "success";
            }
            else if (cap_rate_80 < 10) {
                td_class = "danger"; 
            }

            $('#bedrooms_' + bedroom_count + '_count_for_sale').html(thisListing.count_for_sale);
            $('#bedrooms_' + bedroom_count + '_avg_price').html(displayNumber(thisListing.avg_price, 0, '$'));
            $('#bedrooms_' + bedroom_count + '_avg_cost').html(displayNumber(thisListing.avg_cost, 0, '$'));
            $('#bedrooms_' + bedroom_count + '_cap_rate').html(cap_rate_80 + '%').removeClass().addClass(td_class);
            $('#bedrooms_' + bedroom_count + '_yearly_roi').html(yearly_roi_80 + '%').removeClass().addClass(td_class);


        }
    }

    function singleHouseAnalysis(marker, display_it) {
        id = marker.id;
        address = marker.address;
        bedrooms = cleanNumber(marker.bedrooms);
        bathrooms = cleanNumber(marker.bathrooms);
        photo_url = marker.photo_url;
        sq_ft = cleanNumber(marker.sqft);
        price = cleanNumber(marker.price);
        down_payment = calculateDownPayment(price);
        closing_costs = calculateClosingCosts(price);
        furnishing_costs = calculateFurnishingCosts(price);
        total_acquisition_cost = down_payment + closing_costs + furnishing_costs;
        
        mortgage_payment = calculateMortgage(price);
        property_tax = calculatePropertyTax(price);
        mortgage_insurance = calculateMortgageInsurance(price);
        short_term_insurance = calculateShortTermInsurance(price);
        hoa = 0;
        utilities_internet = calculateUtilitiesInternet(sq_ft);
        repairs = calculateRepairs(price);
        
        revenue = getAvgBookingsByBedrooms(bedrooms);
        if (revenue) {
            bookings_eighty_percent = revenue.eighty_pct;
            bookings_average = revenue.avg_bookings;
            management_fee = calculateManagementFee(bookings_eighty_percent);
        
            op_ex_per_month = mortgage_payment + property_tax + mortgage_insurance + short_term_insurance + hoa + utilities_internet + repairs + management_fee;
            op_ex_per_year = op_ex_per_month * 12;

            monthly_net_average = bookings_average - op_ex_per_month;
            yearly_net_average = monthly_net_average * 12;
            yearly_roi_average = calculateROI(yearly_net_average, down_payment, closing_costs, furnishing_costs);
            cap_rate_average = calculateCapRate(price, bookings_average, op_ex_per_month, mortgage_payment);

            monthly_net_80 = bookings_eighty_percent - op_ex_per_month;
            yearly_net_80 = monthly_net_80 * 12;
            yearly_roi_80 = calculateROI(yearly_net_80, down_payment, closing_costs, furnishing_costs);
            cap_rate_80 = calculateCapRate(price, bookings_eighty_percent, op_ex_per_month, mortgage_payment);


            

            house_object = { 
                "id": id,
                "address": address,
                "bedrooms": bedrooms,
                "bathrooms": bathrooms,
                "photo_url": photo_url,
                "sq_ft": sq_ft,
                "price": price,
                "down_payment": down_payment,
                "closing_costs": closing_costs,
                "furnishing_costs": furnishing_costs,
                "total_acquisition_cost": total_acquisition_cost,
                "bookings_average": bookings_average,
                "bookings_eighty_percent": bookings_eighty_percent,
                "mortgage_payment": mortgage_payment,
                "property_tax": property_tax,
                "mortgage_insurance": mortgage_insurance,
                "short_term_insurance": short_term_insurance,
                "utilities_internet": utilities_internet,
                "repairs": repairs,
                "management_fee": management_fee,
                "op_ex_per_month": op_ex_per_month, 
                "op_ex_per_year": op_ex_per_year,
                "monthly_net_average": monthly_net_average,
                "yearly_net_average": yearly_net_average,
                "yearly_roi_average": yearly_roi_average,
                "cap_rate_average": cap_rate_average,
                "monthly_net_80": monthly_net_80, 
                "yearly_net_80": yearly_net_80,
                "yearly_roi_80": yearly_roi_80,
                "cap_rate_80": cap_rate_80,
                "cap_rate_average": cap_rate_average
            }

            if (display_it) {
                displayHouseAnalysis(house_object);
            }

            return house_object;
        }
        else {
            console.log('singleHouseAnalysis.getAvgBookingsByBedrooms returns nothing');

            return {}
        }


    }

    function displayHouseAnalysis(house_object) {
        $('#profit_loss_address').text(house_object.address);
        $('#profit_loss_bedrooms').text(house_object.bedrooms);
        $('#profit_loss_bathrooms').text(house_object.bathrooms);
        $('#profit_loss_sq_ft').text(displayNumber(house_object.sq_ft, 0));
        $('#profit_loss_price').text(displayNumber(house_object.price, 0, '$'));
        $('#profit_loss_down_payment').text(displayNumber(house_object.down_payment, 0, '$'));
        $('#profit_loss_closing_costs').text(displayNumber(house_object.closing_costs, 0, '$'));
        $('#profit_loss_furnishing_costs').text(displayNumber(house_object.furnishing_costs, 0, '$'));
        $('#profit_loss_total_acquisition_cost').text(displayNumber(house_object.total_acquisition_cost, 0, '$'));
        $('#profit_loss_bookings_average').text(displayNumber(house_object.bookings_average, 0, '$'));
        $('#profit_loss_bookings_eighty_percent').text(displayNumber(house_object.bookings_eighty_percent, 0, '$'));
        $('#profit_loss_mortgage_payment').text(displayNumber(house_object.mortgage_payment, 0, '$'));
        $('#profit_loss_property_tax').text(displayNumber(house_object.property_tax, 0, '$'));
        $('#profit_loss_mortgage_insurance').text(displayNumber(house_object.mortgage_insurance, 0, '$'));
        $('#profit_loss_short_term_insurance').text(displayNumber(house_object.short_term_insurance, 0, '$'));
        $('#profit_loss_utilities_internet').text(displayNumber(house_object.utilities_internet, 0, '$'));
        $('#profit_loss_repairs').text(displayNumber(house_object.repairs, 0, '$'));
        $('#profit_loss_management_fee').text(displayNumber(house_object.management_fee, 0, '$'));
        $('#profit_loss_op_ex_per_month').text(displayNumber(house_object.op_ex_per_month, 0, '$'));
        $('#profit_loss_op_ex_per_month_2').text(displayNumber(house_object.op_ex_per_month*-1, 0, '$'));
        $('#profit_loss_op_ex_per_month_3').text(displayNumber(house_object.op_ex_per_month*-1, 0, '$'));
        $('#profit_loss_op_ex_per_year').text(displayNumber(house_object.op_ex_per_year, 0, '$'));
        $('#profit_loss_monthly_net_average').text(displayNumber(house_object.monthly_net_average, 0, '$'));
        $('#profit_loss_yearly_net_average').text(displayNumber(house_object.yearly_net_average, 0, '$'));
        $('#profit_loss_yearly_roi_average').text(displayNumber(house_object.yearly_roi_average, 2, '%'));
        $('#profit_loss_cap_rate_average').text(displayNumber(house_object.cap_rate_average, 2, '%'));
        $('#profit_loss_monthly_net_80').text(displayNumber(house_object.monthly_net_80, 0, '$'));
        $('#profit_loss_yearly_net_80').text(displayNumber(house_object.yearly_net_80, 0, '$'));
        $('#profit_loss_yearly_roi_80').text(displayNumber(house_object.yearly_roi_80, 2, '%'));
        $('#profit_loss_cap_rate_80').text(displayNumber(house_object.cap_rate_80, 2, '%'));
    }

    
    /* utilFunctions */

    // house_cost = cost of house
    // down_payment_pct = down payment percent
    // loan_years = years of loan
    // interest_rate = yearly interest rate
    function calculateMortgage(house_cost, down_payment_percent, loan_years, interest_rate) {
        //default values
        if (down_payment_percent === undefined)
            down_payment_percent = 20;

        if (loan_years === undefined)
            loan_years = 30;

        if (interest_rate === undefined)
            interest_rate = 5;

        //get principle, amount of loan
        var principle = house_cost * (1 - (down_payment_percent / 100));
        //turn years into months
        var num_months = loan_years * 12;
        //turn i into a monthly interest rate
        interest_rate = interest_rate / 100 / 12;
        return Math.round(principle * interest_rate * (Math.pow(1 + interest_rate, num_months)) / (Math.pow(1 + interest_rate, num_months) - 1));
    }

    function calculateDownPayment(house_price) {
        return house_price * .2;
    }

    function calculateClosingCosts(house_price) {
        return house_price * .04;
    }

    function calculateFurnishingCosts(house_price) {
        return house_price * .15;
    }

    function calculatePropertyTax(house_price) {
        return ((house_price / 100000) * {{ place.monthly_property_tax_per_100k }});
    }

    function calculateMortgageInsurance(house_price) {
        return ((house_price / 100000) * {{ place.monthly_mortgage_insurance_per_100k }});
    }

    function calculateShortTermInsurance(house_price) {
        return ((house_price / 100000) * {{ place.monthly_short_term_insurance_per_100k }});
    }

    function calculateUtilitiesInternet(house_sqft) {
        return (house_sqft * {{ place.monthly_utilities_per_sq_ft }}) + {{ place.monthly_internet_fee }};
    }

    function calculateRepairs(house_price) {
        return (house_price * .01) / 12;
    }

    function calculateManagementFee(bookings) {
        return bookings * ({{ place.monthly_management_fee }} / 100);
    }

    function calculateROI(yearly_net_average, down_payment, closing_costs, furnishing_costs) {
        return displayNumber((yearly_net_average / (down_payment + closing_costs + furnishing_costs)) * 100, 1);
    }

    function calculateCapRate(price, monthly_bookings, monthly_op_ex, monthly_mortgage) {
        //op_ex comes with mortgage cost included, but cap rate does not take
        //  mortgage into account so it needs to be deducted
        cap_rate = (((monthly_bookings - (monthly_op_ex - monthly_mortgage)) * 12) / price) * 100;
        if (cap_rate == Infinity)
            return 'n/a';
        else
            return displayNumber(cap_rate, 1);
    }

    function cleanNumber(num) {
        if (num != undefined)
            return Number(num.replace(/[^0-9\.]+/g,""));
        else
            return false;
    }

    function displayNumber(num, num_decimals, display_type) {
        if (num != undefined) {
            var parts = num.toString().split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            
            if (parts[1] && num_decimals > 0) {
                parts[1] = parts[1].substring(0, num_decimals);
                parts = parts.join(".");
            }
            else
                parts = parts[0];

            if (display_type == "$")
                return "$" + parts;
            else if (display_type == "%")
                return parts + "%";
            else
                return parts;
        }
        else {
            return 0;
        }

    }

    function getAvgBookingsByBedrooms(rooms) {
        var result = $.grep(avg_bookings_by_bedrooms, function(item){
            return item.i_bedrooms == cleanNumber(rooms.toString());
        });
        if (result.length > 0)
            return result[0];
        else
            return { "eighty_pct": 0, "avg_bookings": 0 };
    }

    function getColor(bedrooms) {
        try {
            if (colors[bedrooms] !== undefined) {
                return colors[bedrooms]
            }
            else if (colors[bedrooms.substring(0,1)] !== undefined) {
                return colors[bedrooms.substring(0,1)];
            }
            else {
                return colors[0];
            }
        }
        catch (e) {
            return colors[0];
        }
        
    }

    </script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key_js_map }}">
    </script>
    <script>
    $(document).ready(function() {
        initMap();
    });
    </script>

    <br />
    

{% endblock %}